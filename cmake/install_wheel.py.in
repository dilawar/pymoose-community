"""
DO NOT EDIT THIS FILE. It is generated by cmake from cmake/install_wheel.py.in.
Edit that file instead.

All variables of type @FOO@ will be replaced by cmake configure_file() call
"""

from pathlib import Path
import wheel
import pip
import os
import subprocess
import sys

NAME = Path(__file__).name
pwd_ = Path("@CMAKE_BINARY_DIR@")
os.chdir(pwd_)

assert Path(os.getcwd()) == pwd_
print(f"{NAME}: We are in {os.getcwd()}")

prefix_ = Path("@CMAKE_INSTALL_PREFIX@")

wheels = list(pwd_.glob("pymoose-@VERSION_MOOSE@-*.whl"))
try:
    assert len(wheels) > 0, "Could not find any wheel for given version"
except Exception:
    wheels = list(pwd_.glob("pymoose-*.whl"))

# FIXME: sort by mtime may be and then get the first entry?
wheel = wheels[0]

print(f"{NAME}: installing {wheel} prefix={prefix_}")
cmd = [sys.executable, "-m", "pip", "install", str(wheel)]

# use prefix when user can write to it.
if os.access(prefix_, os.W_OK | os.X_OK):
    cmd += ["--prefix", str(prefix_)]
else:
    print(f"{NAME}: You don't have permission to write in {prefix_}")
    print(f"{NAME}: I will use the defaults.")

print(f"{NAME}: Executing command {' '.join(cmd)}")
s = subprocess.check_output(cmd, universal_newlines=True)
print(f'{NAME}: {s}')
